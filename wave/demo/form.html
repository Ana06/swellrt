<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SwellRT, Collaborative Web Browser Demo</title>

  <style type="text/css">

  /* @import url(http://fonts.googleapis.com/css?family=Oswald); */
  @import url(http://fonts.googleapis.com/css?family=Open+Sans);

  .app {
    font-family: "Open Sans", "Arial", sans-serif;
  }

  .app label {
    display:block;
  }

  .app input {
    margin-bottom: 1em;
  }

  .center {
    display: block;
    margin: 0 auto;
  }

  .app .logo {
    width: 190px;
    display: block;
    margin: 0 auto;
    padding-top: 1em;
    padding-bottom: 1em;
  }

  .app .title {
    padding-top:0.5em;
    margin-top:0.5em;
    text-align:center;
    border-top: 1px solid grey;
  }

  .app .formbox {
    width: 170px;
    margin: 0 auto;
  }

  .formbox .submit {
    text-align:center;
  }

  </style>
</head>

<body class="app">


  <img class="logo" src="img/swellrt-logo-h-medium.png" />
  <h2 class="title">Form Demo</h2>

  <div class="formbox">
    <div>
      <label>Name</label>
      <input id="iName" type="text" placeholder="Name here" />
    </div>
    <div>
      <label>Postal Address</label>
      <input id="iPostalAddress" type="text" placeholder="Address here" />
    </div>

    <div>
      <label>Age</label>
      <input id="iAge" type="text" placeholder="Age here" />
    </div>

    <div class="submit">
      <input id="btnSubmit" type="button" value="Update" />
    </div>

    <div style="font-size: 10px">
      Version: <span id="version">none</span><br />
      Timestamp: <span id="timestamp">none</span>
    </div>
  </div>


  <script src="../swellrt-beta.js"></script>

  <script>

  var api;

  swellrt.onReady(function(service) {

    api = service;
    _api = service;

    api.login({

      id : "_anonymous_",
      password : ""

    })
    .then(r=>{
      console.log("login successful");
      bind();
    })
    .catch(e=>{
      _exception = e;
      console.log(e);
      window.alert("Error");
    });

  });


  function bind() {

    console.log("binding with real-time backend");

    // Put on eye on live commucation turbulences
    api.setConnectionHandler(connectionHandler);

    api.open({

      id : "local.net/demo-form-1"

    }).then(r=>{
      console.log("sync object opened");

      var syncObjectController = r.controller;
      _c = r.controller; // debugging

      // Put on eye on object's health
      syncObjectController.setStatusHandler(objectHandler);

      // Initialize
      var object = syncObjectController.asNative();
      var lastVersion;

      if (!object.form) {

        // Initialize data:
        // This syntax create a one-piece object
        // associated with property 'form'.
        // Changes in form.* are not captured,
        // instead you should replace the whole form
        // value.
        object.form = {
          name: "",
          address : "",
          age : 0,
          timestamp : "",
          version : 0
        };

        // Make public after initialization
        syncObjectController.makePublic(true);
        lastVersion = 0;

      } else {
        // Show current data
        populateForm(object.form);
        showVersion(object.form.version, object.form.timestamp);
        lastVersion = object.form.version;
      }


      // Bind sync object to form
      api.listen(object, function(event) {

        // Note: this hanlder is invoked
        // both from local or remote changes.

        if (!event) return;

        if (event.key == "form" &&
        event.type == swellrt.SEvent.UPDATED_VALUE) {

          var formData = event.value.get();

          if (lastVersion != formData.version) {
            lastVersion = formData.version;
            populateForm(formData);
            showVersion(formData.version, formData.timestamp);
          }
        }
      });

      // Bind form to sync object
      submit = document.getElementById('btnSubmit');
      submit.addEventListener("click", function(e) {

        var data = consultForm();
        data.timestamp = new Date();
        lastVersion = data.version = lastVersion+1;

        // update the object
        object.form = data;
        showVersion(data.version, data.timestamp);

        return false;
      }, true);


    });

  }

  function consultForm() {

    return {
      name : document.getElementById('iName').value,
      address : document.getElementById('iPostalAddress').value,
      age : document.getElementById('iAge').value
    };

  }

  function populateForm(data) {
      document.getElementById('iName').value = data.name;
      document.getElementById('iPostalAddress').value = data.address;
      document.getElementById('iAge').value = data.age;
  }

  function showVersion(version, timestamp) {
    document.getElementById('version').innerHTML = version;
    document.getElementById('timestamp').innerHTML = timestamp;
  }

  // Utility functions

  function objectHandler(s) {
    var m = "";
    if (s.type == 1) {
      m += "error "+s.exception;
    }
    if (s.type == 2) {
      if (s.uncommitted == s.unacknowledge == s.inflight == 0)
        m += "all changes saved v="+s.lastCommittedVersion;
      else
        return;
    }
    if (s.type == 3) {
      m += "closed";
    }
    console.log(m);
  }


  function connectionHandler(s, e) {
    if (s == "CONNECTED")
      console.log("(Websocket) connected");
    if (s == "CONNECTING")
      console.log("(Websocket) connecting");
    if (s == "DISCONNECTED")
      console.log("(Websocket) disconnected");
    if (s == "ERROR")
      console.log("(Websocket) error "+e);
  }

  </script>


</body>

</html>
